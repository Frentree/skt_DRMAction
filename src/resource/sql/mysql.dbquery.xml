<?xml version="1.0" encoding="EUC-KR"?>

<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"  "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="query">
	<select id="getDelDatePathList" parameterClass="String" resultClass="com.skyun.recon.util.database.ibatis.vo.pathVo">
	   SELECT hostname, REPLACE(REPLACE(PATH, '\\', '\\\\'), 'File path ', '') AS path, type, MAX(REGDATE) AS regdate
		FROM drm_job DRM
	   WHERE TYPE = 'IS_ENCRYPT'
		   AND DONE = '1'
		   AND SUCCESS = '1'
		   AND RESULT LIKE ' RETURN 1%'
		   AND date(REGDATE) >= CURDATE() - INTERVAL 7 DAY
	   GROUP BY HOSTNAME, DRM.PATH, TYPE
	</select>
	
	<select id="getDRMJob" parameterClass="String" resultClass="com.skyun.recon.util.database.ibatis.vo.pathVo">
	   SELECT S.SCHEDULE_TARGET_NAME AS hostname, REPLACE(REPLACE(SL.NAME, 'FILE PATH ', ''), '_DECRYPTED.', '.') AS path
		FROM PI_SCHEDULED_LOCATION SL, PI_SCHEDULES S, PI_AP_SERVER AP
	   WHERE SL.SCH_ID = S.SCHEDULE_ID
			AND SL.AP_NO = S.AP_NO 
			AND SL.AP_NO = AP.AP_NO 
			AND AP.IS_SERVER NOT IN ('1')
			AND S.SCHEDULE_LABEL LIKE '%_DRM'
			AND S.SCHEDULE_TARGET_ID = SL.TARGET_ID 
			AND S.DRM_STATUS IN ('C')
			AND FROM_UNIXTIME(SL.STARTED, '%Y-%m-%d') > DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -1 WEEK), '%Y-%m-%d')
	   ORDER BY 1 DESC
	</select>
	
</sqlMap>
